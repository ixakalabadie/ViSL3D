<html>
	 <head>
		 <title> HCG31 </title>
		 <script type='text/javascript' src='http://www.x3dom.org/download/1.8.0/x3dom.js'></script>

		 <script type='text/javascript'  src='https://www.maths.nottingham.ac.uk/plp/pmadw/LaTeXMathML.js'></script>
		 <link rel='stylesheet' type='text/css' href='http://www.x3dom.org/release/x3dom.css'></link>
		 <script type='text/javascript' src='https://code.jquery.com/jquery-3.6.3.min.js'></script>

	 	 <style>
	 	   x3d
	 	 	   {
	 	 	 	   border:2px solid darkorange;
	 	    }
	 	    </style>
	 </head>
	 <body>
	 <h1 align="middle"> HCG31 interactive HI datacube with X3D. Version 1 </h1>
	 <hr/>
	 <p style="width:1000px;"> <font size="3">
	 Object: HCG31.<t> Telescope: MeerKAT. RestFreq = 1420.4058 MHz.<br>
	 Center: (RA,Dec,V)=(75.40396 deg, -4.25478 deg, 3955.233 km/s) 
	 <br/>
	 </font> </p>

	<script>
		 //Round a float value to x.xx format
		 function roundTo(value, decimals)
		{
			 return (Math.round(value * 10**decimals)) / 10**decimals;
		 }
	</script>

	<center><x3d id='cubeFixed' width='90\%' height='600px'>
		 <scene>
			 <OrthoViewpoint id="front" bind='false' centerOfRotation='0,0,0' description='RA-Dec view' fieldOfView='[-397.9720919748948,-397.9720919748948,397.9720919748948,397.9720919748948]' isActive='false' metadata='X3DMetadataObject' orientation='0,1,0,3.14' position='0,0,-1137.063119928271' zFar='10000' zNear='0.05' ></OrthoViewpoint>
			 <OrthoViewpoint id="side" bind='false' centerOfRotation='0,0,0' description='V - Dec view' fieldOfView='[-362.80779467389465,-362.80779467389465,362.80779467389465,362.80779467389465]' isActive='false' metadata='X3DMetadataObject' orientation='0,-1,0,1.57' position='-1036.5936990682706,0,0' zFar='10000' zNear='0.05' ></OrthoViewpoint>
			 <OrthoViewpoint id="side2" bind='false' centerOfRotation='0,0,0' description='V - RA view' fieldOfView='[-397.9720919748948,-397.9720919748948,397.9720919748948,397.9720919748948]' isActive='false' metadata='X3DMetadataObject' orientation='1,1,1,4.1888' position='0,1137.063119928271,0' zFar='10000' zNear='0.05' ></OrthoViewpoint>
			<inline url="HCG31_htmltube.x3d" nameSpaceName="cube" mapDEFToID="true" onclick="handleClick(event)"/>
		</scene>
	</x3d></center>

	<br><br>

	<div id="divmaster" style="margin-left: 2%">
		<!-- BUTTON TO CHANGE LAYOUT -->
		<label for="markers-choice"><b>Markers:</b> </label>
		<select id="markers-choice">
			<option value="none">None</option>
			<option value="sphere">Sphere</option>
			<option value="box">Box</option>
			<option value="tube">Tube</option>
			<option value="cone">Cone</option>
		</select>
		<input type="color" id="butcol" value="#ff0000">
		<button id="butcreate" onclick="createmarker()">Create</button>
		<button id="butremove" onclick="removemarker()">Remove</button> <br><br>

	</div>
	<!-- create various layouts for different objects -->
	<div id="spherediv" style="display:none ; margin-left: 2%">
		<input type="number" id="sphX0" min="-284" max="284" step="1" placeholder="RA">
		<input type="number" id="sphY0" min="-232" max="232" step="1" placeholder="Dec">
		<input type="number" id="sphZ0" min="-259" max="259" step="1" placeholder="V">
		<input type="number" id="sphrad0" min="0" max="50" step="0.5" placeholder="Radius">
	</div>
	<div id="boxdiv" style="display:none ; margin-left: 2%">
		<input type="number" id="boxX0" min="-284" max="284" step="1" placeholder="RA">
		<input type="number" id="boxY0" min="-232" max="232" step="1" placeholder="Dec">
		<input type="number" id="boxZ0" min="-259" max="259" step="1" placeholder="V">
		<input type="text" id="boxrad0" placeholder="shape, e.g. '20 20 20'">
	</div>
	<div id="tubediv" style="display:none ; margin-left: 2% ; width: 80%">
		<br>
		<button id="newtube" onclick="newtube()">New</button>
		<button id="addpoint" onclick="addpoint()">Add point</button>
		<select id="new-tubes">
			<option value="none">None</option>
		</select>
		<br>
	</div>

		<!-- NEW -->
		<script>
			var ngeo = 0; //number of new geometrical shapes
			var tubelen = []; //number of cylinders in each tube
			var npoints = 0; // number of points of a tube (number of cylinders -1)(is changed for each tube)

			const marktype = document.querySelector('#markers-choice');
		 	marktype.addEventListener('change', newlayout);

			const selTube = document.querySelector('#new-tubes');
		 	selTube.addEventListener('change', changeTube)

			const sscasv = document.querySelector('#scalev');
			const col = document.querySelector('#butcol');

			function addpoint() {
				const tubeIndex = selTube.value.split('');
				const tubeInd = tubeIndex[tubeIndex.length-1];
				npoints = tubelen[tubeInd] + 2; // add 2 to add one point more. tubelen gives the number of cylinders.
				const newra = document.createElement('input');
				newra.setAttribute('type', 'number');
				newra.setAttribute('id', 'tub'+tubeInd+'X'+(npoints-1));
				newra.setAttribute('placeholder', 'RA');
				newra.setAttribute('min', '-284');
				newra.setAttribute('max', '284');
				newra.setAttribute('step', '1');

				const newdec = document.createElement('input');
				newdec.setAttribute('type', 'number');
				newdec.setAttribute('id', 'tub'+tubeInd+'Y'+(npoints-1));
				newdec.setAttribute('placeholder', 'Dec');
				newdec.setAttribute('min', '-232');
				newdec.setAttribute('max', '232');
				newdec.setAttribute('step', '1');

				const newv = document.createElement('input');
				newv.setAttribute('type', 'number');
				newv.setAttribute('id', 'tub'+tubeInd+'Z'+(npoints-1));
				newv.setAttribute('placeholder', 'V');
				newv.setAttribute('min', '-259');
				newv.setAttribute('max', '259');
				newv.setAttribute('step', '1');
				const newline = document.createElement("br");
				document.getElementById('div'+selTube.value).appendChild(newline);
				document.getElementById('div'+selTube.value).appendChild(newra);
  				//document.getElementById('tubediv').insertBefore(newra, null); //document.getElementById('addp')
				document.getElementById('div'+selTube.value).appendChild(newdec);
  				//document.getElementById('tubediv').insertBefore(newdec, null);
				document.getElementById('div'+selTube.value).appendChild(newv);
  				//document.getElementById('tubediv').insertBefore(newv, null);

				tubelen[tubeInd] = npoints - 1;
				//alert(tubelen[tubeInd])
				//alert(tubelen)
			}


			function newtube() {
				tubelen.push(1);
				const l = tubelen.length-1;

				if (selTube.value != 'none') {
					document.getElementById('div'+selTube.value).style.display = 'none'
					const len = document.getElementById("new-tubes").length
					document.getElementById("new-tubes")[len] = new Option('tube'+l, 'tube'+l, true, true);
				} else {
					document.getElementById("new-tubes")[0] = new Option('tube'+l, 'tube'+l, true, true); //this value is selected in the input button
				}
				//alert(tubelen)
				// move tubediv0 here. use new button to create new div, no coordinate inputs from start
				const newdiv = document.createElement('div');
				document.getElementById('tubediv').appendChild(newdiv);
				newdiv.setAttribute('id', 'divtube'+l);
				newdiv.setAttribute('style', 'margin-left: 2%');
				newdiv.appendChild(document.createElement("br"));
				
				// create different radius for each tube
				//<input type="number" id="tubrad" min="0" max="50" step="0.5" placeholder="Radius">
				const newrad = document.createElement('input');
				newrad.setAttribute('type', 'number');
				newrad.setAttribute('id', 'tubrad'+l);
				newrad.setAttribute('min', '0');
				newrad.setAttribute('max', '50');
				newrad.setAttribute('step', '0.5');
				newrad.setAttribute('placeholder', 'Radius');
				newdiv.appendChild(newrad);

				for (i=0 ; i<2 ; i++) {
					const newra = document.createElement('input');
					newra.setAttribute('type', 'number');
					newra.setAttribute('id', 'tub'+l+'X'+i);
					newra.setAttribute('placeholder', 'RA');
					newra.setAttribute('step', '1');
					//alert(l+'tubX'+i)

					const newdec = document.createElement('input');
					newdec.setAttribute('type', 'number');
					newdec.setAttribute('id', 'tub'+l+'Y'+i);
					newdec.setAttribute('placeholder', 'Dec');
					newdec.setAttribute('step', '1');

					const newv = document.createElement('input');
					newv.setAttribute('type', 'number');
					newv.setAttribute('id', 'tub'+l+'Z'+i);
					newv.setAttribute('placeholder', 'V');
					newv.setAttribute('step', '1');

					const newline = document.createElement("br");

					newdiv.appendChild(newline);
					newdiv.appendChild(newra);
					newdiv.appendChild(newdec);
					newdiv.appendChild(newv);
				}			
			}

			function newlayout() {
				document.getElementById('spherediv').style.display = 'none'
				document.getElementById('boxdiv').style.display = 'none'
				document.getElementById('tubediv').style.display = 'none'
				name = marktype.value+'div'
				document.getElementById(name).style.display = 'inline-block'
			}
			
			function createmarker() {
				const tubeIndex = selTube.value.split('');
				const tubeInd = tubeIndex[tubeIndex.length-1];
				npoints = tubelen[tubeInd] + 1
				if (document.getElementById(tubeInd+'newtra0') == null) {
					for (i=0; i<npoints-1; i++) {
						// read and save the values of the points
						const x0 = Number(document.querySelector('#tub'+tubeInd+'X'+i).value); //.value is a string. transform to Number()
						const y0 = Number(document.querySelector('#tub'+tubeInd+'Y'+i).value);
						const z0 = Number(document.querySelector('#tub'+tubeInd+'Z'+i).value);
						const x1 = Number(document.querySelector('#tub'+tubeInd+'X'+(i+1)).value);
						const y1 = Number(document.querySelector('#tub'+tubeInd+'Y'+(i+1)).value);
						const z1 = Number(document.querySelector('#tub'+tubeInd+'Z'+(i+1)).value);
						//alert('x0: '+x0+' y0: '+y0+' z0: '+z0+' x1: '+x1+' y1: '+y1+' z1: '+z1)
						// read and save radius
						const rad = document.querySelector('#tubrad'+tubeInd);
						// calculate parameters for the cylinder
						const trans  = [(x0+x1)/2, (y0+y1)/2, (z0+z1)/2]
						const diff = [x1-x0, y1-y0, z1-z0]
						const height = Math.sqrt(diff[0]**2+diff[1]**2+diff[2]**2);
						const angle = Math.acos(diff[1]/height);

						// create the cylinder, give color, IDs and radius
						const newtra = document.createElement('transform');
						newtra.setAttribute('id', tubeInd+'newtra'+i);
						const newshape = document.createElement('shape');
						newshape.setAttribute('id', tubeInd+'newsha'+i);
						const newape = document.createElement('appearance');
						const newmat = document.createElement('material');
						newmat.setAttribute('diffuseColor', col.value);
						newmat.setAttribute('id', tubeInd+'mat'+i);
						//alert(rad.value);
						const newgeo = document.createElement('cylinder');
						newgeo.setAttribute('id', tubeInd+'newcyl'+i);
						newgeo.setAttribute('radius', rad.value);
						newgeo.setAttribute('solid', 'false');
						
						//alert(diff[2]+' 0 '+(-diff[0])+' '+angle);
						//alert(height.toString());
						//alert(trans.toString());
						// set cylinder height, translation and rotation
						newgeo.setAttribute('height', height.toString());
						newtra.setAttribute('translation', trans.toString());
						newtra.setAttribute('rotation', diff[2]+' 0 '+(-diff[0])+' '+angle);
						newshape.appendChild(newape).appendChild(newmat);
						newtra.appendChild(newshape).appendChild(newgeo);
						//alert(newtra.innerHTML)
						//alert(document.getElementById('cube__ROOT').appendChild(newtra).appendChild(newshape).appendChild(newgeo).innerHTML)
						document.getElementById('cube__ROOT').appendChild(newtra);
					}
				} else {
					for (i=0; i<npoints-1; i++) {
						// read and save the values of the points
						const x0 = Number(document.querySelector('#tub'+tubeInd+'X'+i).value); //.value is a string. transform to Number()
						const y0 = Number(document.querySelector('#tub'+tubeInd+'Y'+i).value);
						const z0 = Number(document.querySelector('#tub'+tubeInd+'Z'+i).value);
						const x1 = Number(document.querySelector('#tub'+tubeInd+'X'+(i+1)).value);
						const y1 = Number(document.querySelector('#tub'+tubeInd+'Y'+(i+1)).value);
						const z1 = Number(document.querySelector('#tub'+tubeInd+'Z'+(i+1)).value);
						//alert('x0: '+x0+' y0: '+y0+' z0: '+z0+' x1: '+x1+' y1: '+y1+' z1: '+z1)
						// read and save radius
						const rad = document.querySelector('#tubrad'+tubeInd);
						// calculate parameters for the cylinder
						const trans  = [(x0+x1)/2, (y0+y1)/2, (z0+z1)/2]
						const diff = [x1-x0, y1-y0, z1-z0]
						const height = Math.sqrt(diff[0]**2+diff[1]**2+diff[2]**2);
						const angle = Math.acos(diff[1]/height);
						document.getElementById(tubeInd+'newtra'+i).setAttribute('rotation', diff[2]+' 0 '+(-diff[0])+' '+angle);
						//alert('rotation')
						document.getElementById(tubeInd+'newtra'+i).setAttribute('translation', trans.toString());
						//DOES NOT FIND MATERIAL ELEMENT
						//documemt.getElementById(tubeInd+'mat'+i).setAttribute('diffusecolor', col.value);
						document.getElementById(tubeInd+'newcyl'+i).setAttribute('height', height.toString());
						document.getElementById(tubeInd+'newcyl'+i).setAttribute('radius', rad.value);
					}
				}
			}

			function removemarker() {
				const tubeIndex = selTube.value.split('');
				const tubeInd = tubeIndex[tubeIndex.length-1];
				npoints = tubelen[tubeInd] + 1
				if (tubelen.length === 1) {
					document.getElementById("new-tubes")[tubeInd] = new Option('None', 'none', false, false);
				} else {
					document.getElementById("new-tubes")[tubeInd].remove();
					document.getElementById("new-tubes")[0].setAttribute('selected', 'selected');
					const nexttube = document.getElementById("new-tubes")[0].value;
					document.getElementById('div'+nexttube).style.display = 'inline-block';
				}				
				for (i=0; i<npoints-1; i++){
					document.getElementById(tubeInd+'newtra'+i).remove();
				}
				document.getElementById('divtube'+tubeInd).remove();
				
			}

			function changeTube() {
				for (i=0; i<tubelen.length; i++) {
					alert(selTube.value)
					if ('tube'+i != selTube.value) {
						if (document.getElementById('divtube'+i) != null) {
							document.getElementById('divtube'+i).style.display = 'none';
						}
					}
					document.getElementById('div'+selTube.value).style.display = 'inline-block';
				}
			}

		</script>


<!--A table with navigation info for X3DOM-->
<br/>
<hr>
<h3><b>Navigation:</b></h3>
<table style="border-collapse: collapse; border: 2px solid rgb(0,0,0);">
<tbody><tr style="background-color: rgb(220,220,220); border: 1px solid rgb(0,0,0);">
<th width="250px">Function</th>
<th>Mouse Button</th>
</tr>
</tbody><tbody>
<tr style="background-color: rgb(240,240,240);"><td>Rotate</td>
<td>Left / Left + Shift</td>
</tr>
<tr><td>Pan</td>
<td>Mid / Left + Ctrl</td>
</tr>
<tr style="background-color: rgb(240,240,240);"><td>Zoom</td>
<td>Right / Wheel / Left + Alt</td>
</tr>
<tr><td>Set center of rotation</td>
<td>Double-click left</td>
</tr>
</tbody>
</table>
	</body>
</html>